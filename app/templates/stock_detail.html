{% extends 'base.html' %}

{% block title %}{{ stock.symbol }} - Detalle{% endblock %}

{% block content %}
<a href="{% url 'home' %}" class="back-link">← Volver al inicio</a>

<div class="stock-header">
    <div>
        <h1>{{ stock.symbol }}</h1>
        <p class="stock-name">{{ stock.name|default:"Sin nombre" }}</p>
    </div>
    {% if stats %}
    <div class="stock-price-info">
        <div class="current-price">
            <span class="price-label">Precio Actual</span>
            <span class="price-value">${{ stats.current_price|floatformat:2 }}</span>
            <span class="price-change {% if stats.change >= 0 %}positive{% else %}negative{% endif %}">
                {{ stats.change|floatformat:2 }} ({{ stats.change_percent|floatformat:2 }}%)
            </span>
        </div>
    </div>
    {% endif %}
</div>

<!-- Filtros de fecha -->
<div class="section">
    <form method="get" class="date-filter-form">
        <div class="date-filters">
            <div class="form-group-inline">
                <label for="start_date">Desde:</label>
                <input type="date" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" class="form-input-small">
            </div>
            
            <div class="form-group-inline">
                <label for="end_date">Hasta:</label>
                <input type="date" id="end_date" name="end_date" value="{{ end_date|date:'Y-m-d' }}" class="form-input-small">
            </div>
            
            <button type="submit" class="btn-primary">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 14L10 10M11.3333 6.66667C11.3333 9.244 9.244 11.3333 6.66667 11.3333C4.08934 11.3333 2 9.244 2 6.66667C2 4.08934 4.08934 2 6.66667 2C9.244 2 11.3333 4.08934 11.3333 6.66667Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Filtrar
            </button>
            
            <button type="button" class="btn-secondary" onclick="resetFilters()">Últimos 30 días</button>
        </div>
    </form>
    
    <p class="data-info">Mostrando {{ data_points }} punto(s) de datos</p>
</div>

{% if stats %}
<div class="section">
    <h2>Estadísticas del Período</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-label">Precio Máximo</span>
            <span class="stat-value">${{ stats.max_price|floatformat:2 }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Precio Mínimo</span>
            <span class="stat-value">${{ stats.min_price|floatformat:2 }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Precio Promedio</span>
            <span class="stat-value">${{ stats.avg_price|floatformat:2 }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Cambio Total</span>
            <span class="stat-value {% if stats.change >= 0 %}positive{% else %}negative{% endif %}">
                ${{ stats.change|floatformat:2 }}
            </span>
        </div>
    </div>
</div>
{% endif %}

<div class="section">
    <h2>Histórico de Precios</h2>
    <div class="chart-container">
        <canvas id="priceChart"></canvas>
    </div>
</div>

<div class="section">
    <h2>Histórico de Volumen</h2>
    <div class="chart-container">
        <canvas id="volumeChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const chartData = {{ chart_data_json|safe }};

const priceCtx = document.getElementById('priceChart').getContext('2d');
const priceChart = new Chart(priceCtx, {
    type: 'line',
    data: {
        labels: chartData.labels,
        datasets: [{
            label: 'Precio ($)',
            data: chartData.prices,
            borderColor: '#4CAF50',
            backgroundColor: 'rgba(76, 175, 80, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(context) {
                        return 'Precio: $' + context.parsed.y.toFixed(2);
                    }
                }
            }
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Fecha'
                }
            },
            y: {
                display: true,
                title: {
                    display: true,
                    text: 'Precio ($)'
                },
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(2);
                    }
                }
            }
        }
    }
});

const volumeCtx = document.getElementById('volumeChart').getContext('2d');
const volumeChart = new Chart(volumeCtx, {
    type: 'bar',
    data: {
        labels: chartData.labels,
        datasets: [{
            label: 'Volumen',
            data: chartData.volumes,
            backgroundColor: 'rgba(103, 126, 234, 0.6)',
            borderColor: '#677eea',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(context) {
                        return 'Volumen: ' + context.parsed.y.toLocaleString();
                    }
                }
            }
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Fecha'
                }
            },
            y: {
                display: true,
                title: {
                    display: true,
                    text: 'Volumen'
                },
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString();
                    }
                }
            }
        }
    }
});

function resetFilters() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('start_date').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('end_date').value = today.toISOString().split('T')[0];
    
    document.querySelector('.date-filter-form').submit();
}
</script>
{% endblock %}
